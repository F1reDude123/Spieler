<!DOCTYPE html>
<html>
  <head>
    <title>Game.js</title>
    <style>
      body {
        background:#222;
        color:#fff;
        margin-left:308px;
        font-family:"Roboto";
        overflow:clip;
      }

      .sidebar {
        background:#333;
        position:absolute;
        top:0;
        left:0;
        width:300px;
        height:100%;
        overflow:scroll;
      }
      .sidebar * {
      	margin-left:20px;
      }
      hr {
        width:260px;
        border:1px solid #555;
      }

      #canvas {
        background:#000;
        width:100%;
        overflow:clip;
        aspect-ratio:16/9;
        display:block;
        position:relative;
      }
      #canvas * {
        position:absolute;
      }
      .modalBg {
        background:#00000050;
        position:absolute;
        top:0;
        left:0;
        width:100%;
        height:100%;
        z-index:1;
        display:none;
      }
      .modal {
        padding:20px;
        background:#333;
        border-radius:10px;
        width:300px;
        text-align:center;
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%, -50%);
      }
      footer {
        background:#222;
        border-top:1px solid #555;
        position:absolute;
        bottom:0;
        width:calc(100% - 316px);
        height:30px;
      }

      input, select {
        background:#222;
        color:#fff;
        border:1px solid #555;
        padding:5px;
        border-radius:5px;
      }

      select {
        color-scheme:dark;
      }

      input[type="range"] {
        appearance:none;
        background:#fff;
        border:none;
        height:3px;
        padding:0px;
      }
      input[type="number"] {
        width:50px;
      }

      button {
        background:#36f;
        border:1px solid #36f;
        color:#fff;
        padding:5px;
        border-radius:5px;
      }
      button.footerBtn {
        background:#222;
        border:none;
      }
      button.footerBtn:hover {
        background:#333;
      }
      button.footerBtn:active {
        background:#222;
      }
      .xBtn {
        position:absolute;
        top:0;
        right:0;
        background:#f00;
        border-top-right-radius:10px;
        width:20px;
        height:20px;
        color:#fff;
        user-select:none;
      }

      .pixelWhite {
        background:#fff;
        border:none;
      }
      .pixelDark {
        background:#aaa;
        border:none;
      }
      .pixelSelect {
        width:48px;
        height:48px;
        border:none;
      }

      .pixelWhite:hover, .pixelDark:hover {
        background:#ccc;
        display:inline-block;
      }

      .texContainer {
        max-width:480px;
        max-height:480px;
        width:fit-content;
        height:fit-content;
        display:grid;
        justify-content:center;
      }

      .colorContainer {
        width:480px;
        height:48px;
        display:flex;
        flex-direction:row;
      }
    </style>
  </head>
  <body>
    <div class="sidebar" id="sidebar">
      <h2>Inspector</h2>
      <hr>
      <button onclick="document.getElementById('addElemModal').style.display = 'block';">+ Add element</button>
    </div>
    <div class="canvas" id="canvas"></div>

    <!-- Modal for adding elements -->
    <div class="modalBg" id="addElemModal">
      <div class="modal">
        <span class="xBtn" onclick="this.parentElement.parentElement.style.display = 'none'">&times;</span>
        <h1>Add element</h1>
        <br>
        <input id="elemName" placeholder="Enter element name...">
        <button onclick="addElem(this.previousElementSibling.value); this.parentElement.parentElement.style.display = 'none'; openInspector(elemProps[this.previousElementSibling.value]);">Add</button>
      </div>
    </div>

    <!-- Modal for creating textures -->
    <div class="modalBg" id="createTexModal">
      <div class="modal">
        <span class="xBtn" onclick="this.parentElement.parentElement.style.display = 'none'">&times;</span>
        <h1>Create texture</h1>
        <br>
        <input id="texName" placeholder="Enter texture name...">
        <br>
        <input id="w" type="number" oninput="this.value = Math.min(this.max || 100, Math.max(this.min || 0, this.value));" placeholder="Width" min="1" max="1024">
        <input id="h" type="number" oninput="this.value = Math.min(this.max || 100, Math.max(this.min || 0, this.value));" placeholder="Height" min="1" max="1024">
        <br>
        <br>
        <button onclick="this.parentElement.parentElement.style.display = 'none'; createAndEditTex(document.getElementById('texName').value, parseInt(document.getElementById('w').value), parseInt(document.getElementById('h').value));">Create</button>
      </div>
    </div>

    <!-- Modal for editing textures -->
    <div class="modalBg" id="editTexModal">
      <div class="modal" style="width:480px;">
        <span class="xBtn" onclick="this.parentElement.parentElement.style.display = 'none'">&times;</span>
        <div class="colorContainer">
          <input type="color" style="width:48px;height:48px;" onchange = "color = this.value;">
          <div class="pixelSelect" style="background:#f00;" onclick="color = this.style.background;"></div>
          <div class="pixelSelect" style="background:#f70;" onclick="color = this.style.background;"></div>
          <div class="pixelSelect" style="background:#ff0;" onclick="color = this.style.background;"></div>
          <div class="pixelSelect" style="background:#0f0;" onclick="color = this.style.background;"></div>
          <div class="pixelSelect" style="background:#00f;" onclick="color = this.style.background;"></div>
          <div class="pixelSelect" style="background:#f0f;" onclick="color = this.style.background;"></div>
          <div class="pixelSelect" style="background:#940;" onclick="color = this.style.background;"></div>
          <div class="pixelSelect" style="background:#fff;" onclick="color = this.style.background;"></div>
          <div class="pixelSelect" style="background:#000;" onclick="color = this.style.background;"></div>
        </div>
        <div class="texContainer"></div>
        <button onclick="">Save</button>
      </div>
    </div>

    <footer>
      <button class="footerBtn" onclick="document.getElementById('createTexModal').style.display = 'block';">Texture editor</button>
    </footer>
  </body>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
  <script>
    var frameRate = 60;


    var mousedown = false;


    var files = {
      Gollum: "https://storage.googleapis.com/pod_public/750/119511.jpg"
    };


    var elements = {};
    var elemProps = {};

    function openElemModal() {
      document.getElementById("addElemModal").style.display = "block";
    }

    function addElem(name) {
      var elem = {};
      elemProps[name] = {
        Texture: { value: null, type: "fSelect"},
        X: { value: 50, type: "nInput", min: 0, max: 100},
        Y: { value: 50, type: "nInput", min: 0, max: 100},
        Width: { value: 50, type: "nInput", min: 1, max: 100},
        Height: { value: 50, type: "nInput", min: 1, max: 100}
      };
      
      var img = new Image();
      img.src = "";
      img.style = "";
      img.onclick = openInspector(img);
      document.getElementById("canvas").appendChild(img);
      elements[name] = img;
    }

    function openInspector(elem) {
      Object.keys(elem).forEach(e => {
        var sidebar = document.getElementById("sidebar");

        var p = document.createElement("p");
        p.textContent = e;
        sidebar.appendChild(p);

        switch(elem[e].type) {
          case "tInput":
            var input = document.createElement("input");
            input.placeholder = `Enter ${e}...`;
            input.value = elem[e].value;
            input.oninput = function() {
              elem[e].value = this.value;
            };

            sidebar.appendChild(input);

            break;
          case "nInput":
            var input = document.createElement("input");
            input.type = "number";
            input.min = elem[e].min || 0;
            input.max = elem[e].max || Infinity;
            input.value = elem[e].value;
            input.oninput = function() {
              this.value = Math.min(this.max || 100, Math.max(this.min || 0, this.value));
              elem[e].value = this.value;
            };

            sidebar.appendChild(input);

            break;
          case "rInput":
            var input = document.createElement("input");
            input.type = "range";
            input.min = elem[e].min || 0;
            input.max = elem[e].max || 100;
            input.value = elem[e].value;
            input.oninput = function() {
              elem[e].value = this.value;
            };

            sidebar.appendChild(input);

            break;
          case "fSelect":
            var select = document.createElement("select");
            select.onchange = function() {
              elem[e].value = this.value;
            };

            var defOpt = document.createElement("option");
            defOpt.textContent = "Choose a file";
            defOpt.selected = true;
            defOpt.disabled = true;

            select.appendChild(defOpt);

            Object.keys(files).forEach(file => {
              var opt = document.createElement("option");
              opt.textContent = file;

              select.appendChild(opt);
            });

            sidebar.appendChild(select);

            break;
        }

        sidebar.appendChild(document.createElement("br"));
      });
    }

    var color = "#000";

    function createAndEditTex(name, w, h) {
      if (name == null || !w || !h) return;
      var modal = document.getElementById("editTexModal");
      var editor = modal.children[0].children[2];

      editor.innerHTML = "";

      modal.children[0].children[3].onclick = function() {
        genTex(this.previousElementSibling, name);
        this.parentElement.parentElement.style.display = "none";
      };

      var step = Math.min(480 / w, 480 / h);

      var idx = 0;

      editor.style.gridTemplateColumns = `repeat(${w}, ${step}px)`;
      editor.style.gridTemplateRows = `repeat(${h}, ${step}px)`;

      for (var y = 0; y < h; y++) {
        for (var x = 0; x < w; x++) {
          var block = document.createElement("div");
          block.className = idx % 2 == 0 ? "pixelWhite" : "pixelDark";
          block.style.width = step + "px";
          block.style.height = step + "px";
          block.onmousedown = function() {
            this.className = "";
            this.style.background = color;
          };
          block.onmouseover = function() {
            if (mousedown) {
              this.className = "";
              this.style.background = color;
            }
          };

          editor.appendChild(block);

          idx++;
        }
        idx++;
      }

      modal.style.display = "block";
    }

    function genTex(elem, name) {
      html2canvas(elem).then(canvas => {
      	files[name] = canvas.toDataURL();
      });
    }


    var canvas = document.getElementById("canvas");

    var loop;
    var startLoop = function() {
      loop = setInterval(() => {
        for (var i of Object.keys(elements)) {
          elements[i].src = files[elemProps[i].Texture.value];
          elements[i].style.width = elemProps[i].Width.value + "px";
          elements[i].style.height = elemProps[i].Height.value + "px";
          elements[i].style.left = elemProps[i].X.value + "px";
          elements[i].style.top = elemProps[i].Y.value + "px";
        }
      }, 1000/frameRate);
    }

    startLoop();



    document.addEventListener("mousedown", function() {
      mousedown = true;
    });
    document.addEventListener("mouseup", function() {
      mousedown = false;
    });
  </script>
</html>
